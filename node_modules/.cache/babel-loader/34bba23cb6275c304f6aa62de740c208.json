{"ast":null,"code":"import _regeneratorRuntime from \"/Users/sham/big-calendar/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";\nimport _asyncToGenerator from \"/Users/sham/big-calendar/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";\nimport { GET_EVENTS_BEGIN } from '../actions/events';\nimport { duplicateAction } from '../actions/db/events';\nimport { map, mergeMap, catchError } from 'rxjs/operators';\nimport { ofType } from 'redux-observable';\nimport { from } from 'rxjs';\nimport { normalize, schema } from 'normalizr';\n\nfunction loadGoogleClient() {\n  return _loadGoogleClient.apply(this, arguments);\n}\n\nfunction _loadGoogleClient() {\n  _loadGoogleClient = _asyncToGenerator(\n  /*#__PURE__*/\n  _regeneratorRuntime.mark(function _callee() {\n    var result;\n    return _regeneratorRuntime.wrap(function _callee$(_context) {\n      while (1) {\n        switch (_context.prev = _context.next) {\n          case 0:\n            _context.next = 2;\n            return window.gapi.load('calendar', 'v3');\n\n          case 2:\n            result = _context.sent;\n            return _context.abrupt(\"return\", result);\n\n          case 4:\n          case \"end\":\n            return _context.stop();\n        }\n      }\n    }, _callee, this);\n  }));\n  return _loadGoogleClient.apply(this, arguments);\n}\n\nfunction loadRequest(_x) {\n  return _loadRequest.apply(this, arguments);\n}\n\nfunction _loadRequest() {\n  _loadRequest = _asyncToGenerator(\n  /*#__PURE__*/\n  _regeneratorRuntime.mark(function _callee2(isSync) {\n    var _result, _result2;\n\n    return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n      while (1) {\n        switch (_context2.prev = _context2.next) {\n          case 0:\n            if (!isSync) {\n              _context2.next = 6;\n              break;\n            }\n\n            _context2.next = 3;\n            return window.gapi.client.calendar.events.list({\n              'calendarId': 'primary',\n              'syncToken': syncToken\n            });\n\n          case 3:\n            _result = _context2.sent;\n            _context2.next = 9;\n            break;\n\n          case 6:\n            _context2.next = 8;\n            return window.gapi.client.calendar.events.list({\n              'calendarId': 'primary'\n            });\n\n          case 8:\n            _result2 = _context2.sent;\n\n          case 9:\n            return _context2.abrupt(\"return\", result);\n\n          case 10:\n          case \"end\":\n            return _context2.stop();\n        }\n      }\n    }, _callee2, this);\n  }));\n  return _loadRequest.apply(this, arguments);\n}\n\nexport var beginGetEventsEpics = function beginGetEventsEpics(action$) {\n  return action$.pipe(ofType(GET_EVENTS_BEGIN), mergeMap(function () {\n    var load = loadGoogleClient();\n    mergeMap(function () {\n      var syncToken = localStorage.getItem('sync');\n      var request;\n\n      if (syncToken == null) {\n        console.log('performing full sync');\n        request = loadRequst(false);\n      } else {\n        console.log('performing incremental sync');\n        request = new Promise(function (resolve, reject) {\n          return resolve();\n        });\n      }\n\n      debugger;\n      from(request).pipe(map(function (resp) {\n        var result = [];\n        var results = new Promise(function (resolve, reject) {\n          fetchEvents(resp, result, resolve, reject);\n        });\n        debugger;\n        return duplicateAction();\n      }));\n    });\n    /*window.gapi.client.load('calendar', 'v3')\n      .then(() => {\n        let syncToken = localStorage.getItem('sync');\n        let request;\n        if(syncToken == null) {\n          console.log('performing full sync');\n          request =  window.gapi.client.calendar.events.list({\n            'calendarId' : 'primary'\n          });\n        }\n        else {\n          console.log('performing incremental sync');\n          request = window.gapi.client.calendar.events.list({\n            'calendarId' : 'primary',\n            'syncToken': syncToken\n          });\n        }\n        return request;\n      })\n      .then(resp => {\n        let result = [];\n        const results = new Promise((resolve, reject) => {\n          fetchEvents(resp, result, resolve, reject);\n        })\n        return results;\n      })\n      .then(response => {\n        debugger;\n      })\n      return duplicateAction();*/\n  }));\n};\n\nvar normalizeEvents = function normalizeEvents(response) {\n  var singleEvent = new schema.Entity('events');\n  var results = normalize({\n    events: response\n  }, {\n    events: [singleEvent]\n  });\n  return results;\n};\n\nvar fetchEvents = function fetchEvents(resp, items, resolve, reject) {\n  var newItems = items.concat(resp.result.items);\n  var pageToken = resp.nextPageToken;\n  var syncToken = resp.nextSyncToken;\n\n  if (pageToken !== undefined) {\n    window.gapi.client.calendar.events.list({\n      'calendarId': 'primary',\n      'pageToken': pageToken\n    }).then(function (nextResp) {\n      return fetchEvents(nextResp, newItems, resolve, reject);\n    }).catch(function (e) {\n      if (e.code === 410) {\n        console.log('Invalid sync token, clearing event store and re-syncing.');\n        localStorage.deleteItem('sync');\n        window.gapi.client.calendar.events.list({\n          'calendarId': 'primary'\n        }).then(function (newResp) {\n          return fetchEvents(newResp, items, resolve, reject);\n        });\n      } else {\n        console.log(e);\n        reject('Something went wrong, Please refresh and try again');\n      }\n    });\n  } else {\n    localStorage.setItem('sync', syncToken);\n    resolve(newItems);\n  }\n};","map":{"version":3,"sources":["/Users/sham/big-calendar/src/epics/events.js"],"names":["GET_EVENTS_BEGIN","duplicateAction","map","mergeMap","catchError","ofType","from","normalize","schema","loadGoogleClient","window","gapi","load","result","loadRequest","isSync","client","calendar","events","list","syncToken","beginGetEventsEpics","action$","pipe","localStorage","getItem","request","console","log","loadRequst","Promise","resolve","reject","resp","results","fetchEvents","normalizeEvents","response","singleEvent","Entity","items","newItems","concat","pageToken","nextPageToken","nextSyncToken","undefined","then","nextResp","catch","e","code","deleteItem","newResp","setItem"],"mappings":";;AAAA,SAASA,gBAAT,QAAiC,mBAAjC;AACA,SAASC,eAAT,QAAgC,sBAAhC;AACA,SAASC,GAAT,EAAcC,QAAd,EAAwBC,UAAxB,QAA0C,gBAA1C;AACA,SAASC,MAAT,QAAuB,kBAAvB;AACA,SAASC,IAAT,QAAqB,MAArB;AACA,SAASC,SAAT,EAAoBC,MAApB,QAAkC,WAAlC;;SAEeC,gB;;;;;;;2BAAf;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mBACqBC,MAAM,CAACC,IAAP,CAAYC,IAAZ,CAAiB,UAAjB,EAA6B,IAA7B,CADrB;;AAAA;AACMC,YAAAA,MADN;AAAA,6CAESA,MAFT;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,G;;;;SAKeC,W;;;;;;;2BAAf,kBAA2BC,MAA3B;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA,iBACKA,MADL;AAAA;AAAA;AAAA;;AAAA;AAAA,mBAEuBL,MAAM,CAACC,IAAP,CAAYK,MAAZ,CAAmBC,QAAnB,CAA4BC,MAA5B,CAAmCC,IAAnC,CAAwC;AACzD,4BAAe,SAD0C;AAEzD,2BAAeC;AAF0C,aAAxC,CAFvB;;AAAA;AAEQP,YAAAA,OAFR;AAAA;AAAA;;AAAA;AAAA;AAAA,mBAQuBH,MAAM,CAACC,IAAP,CAAYK,MAAZ,CAAmBC,QAAnB,CAA4BC,MAA5B,CAAmCC,IAAnC,CAAwC;AACzD,4BAAe;AAD0C,aAAxC,CARvB;;AAAA;AAQQN,YAAAA,QARR;;AAAA;AAAA,8CAYSA,MAZT;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,G;;;;AAeA,OAAO,IAAMQ,mBAAmB,GAAG,SAAtBA,mBAAsB,CAAAC,OAAO;AAAA,SAAIA,OAAO,CAACC,IAAR,CAC5ClB,MAAM,CAACL,gBAAD,CADsC,EAE5CG,QAAQ,CAAC,YAAM;AACb,QAAMS,IAAI,GAAIH,gBAAgB,EAA9B;AACAN,IAAAA,QAAQ,CAAC,YAAM;AACb,UAAIiB,SAAS,GAAGI,YAAY,CAACC,OAAb,CAAqB,MAArB,CAAhB;AACA,UAAIC,OAAJ;;AACA,UAAGN,SAAS,IAAI,IAAhB,EAAsB;AACpBO,QAAAA,OAAO,CAACC,GAAR,CAAY,sBAAZ;AACAF,QAAAA,OAAO,GAAGG,UAAU,CAAC,KAAD,CAApB;AACD,OAHD,MAIK;AACHF,QAAAA,OAAO,CAACC,GAAR,CAAY,6BAAZ;AACAF,QAAAA,OAAO,GAAG,IAAII,OAAJ,CAAY,UAACC,OAAD,EAASC,MAAT,EAAoB;AACxC,iBAAOD,OAAO,EAAd;AACD,SAFS,CAAV;AAGD;;AACD;AACAzB,MAAAA,IAAI,CAACoB,OAAD,CAAJ,CAAcH,IAAd,CACErB,GAAG,CAAC,UAAA+B,IAAI,EAAI;AACV,YAAIpB,MAAM,GAAG,EAAb;AACA,YAAMqB,OAAO,GAAG,IAAIJ,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;AAC/CG,UAAAA,WAAW,CAACF,IAAD,EAAOpB,MAAP,EAAekB,OAAf,EAAwBC,MAAxB,CAAX;AACD,SAFe,CAAhB;AAGA;AACA,eAAO/B,eAAe,EAAtB;AACD,OAPE,CADL;AAUD,KAxBO,CAAR;AAyBA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AA8BD,GAzDO,CAFoC,CAAJ;AAAA,CAAnC;;AA8DP,IAAMmC,eAAe,GAAG,SAAlBA,eAAkB,CAACC,QAAD,EAAc;AACpC,MAAIC,WAAW,GAAG,IAAI9B,MAAM,CAAC+B,MAAX,CAAkB,QAAlB,CAAlB;AACA,MAAIL,OAAO,GAAG3B,SAAS,CAAC;AAAEW,IAAAA,MAAM,EAAGmB;AAAX,GAAD,EAAuB;AAAEnB,IAAAA,MAAM,EAAE,CAAEoB,WAAF;AAAV,GAAvB,CAAvB;AACA,SAAOJ,OAAP;AACD,CAJD;;AAMA,IAAMC,WAAW,GAAG,SAAdA,WAAc,CAACF,IAAD,EAAOO,KAAP,EAAcT,OAAd,EAAuBC,MAAvB,EAAkC;AACpD,MAAMS,QAAQ,GAAGD,KAAK,CAACE,MAAN,CAAaT,IAAI,CAACpB,MAAL,CAAY2B,KAAzB,CAAjB;AACA,MAAIG,SAAS,GAAGV,IAAI,CAACW,aAArB;AACA,MAAIxB,SAAS,GAAGa,IAAI,CAACY,aAArB;;AACA,MAAGF,SAAS,KAAKG,SAAjB,EAA4B;AAC1BpC,IAAAA,MAAM,CAACC,IAAP,CAAYK,MAAZ,CAAmBC,QAAnB,CAA4BC,MAA5B,CAAmCC,IAAnC,CAAwC;AACtC,oBAAe,SADuB;AAEtC,mBAAawB;AAFyB,KAAxC,EAGGI,IAHH,CAGQ,UAAAC,QAAQ;AAAA,aAAIb,WAAW,CAACa,QAAD,EAAWP,QAAX,EAAqBV,OAArB,EAA8BC,MAA9B,CAAf;AAAA,KAHhB,EAIGiB,KAJH,CAIS,UAAAC,CAAC,EAAI;AACV,UAAGA,CAAC,CAACC,IAAF,KAAW,GAAd,EAAmB;AACjBxB,QAAAA,OAAO,CAACC,GAAR,CAAY,0DAAZ;AACAJ,QAAAA,YAAY,CAAC4B,UAAb,CAAwB,MAAxB;AACA1C,QAAAA,MAAM,CAACC,IAAP,CAAYK,MAAZ,CAAmBC,QAAnB,CAA4BC,MAA5B,CAAmCC,IAAnC,CAAwC;AACtC,wBAAe;AADuB,SAAxC,EAEG4B,IAFH,CAEQ,UAAAM,OAAO;AAAA,iBAAIlB,WAAW,CAACkB,OAAD,EAAUb,KAAV,EAAiBT,OAAjB,EAA0BC,MAA1B,CAAf;AAAA,SAFf;AAGD,OAND,MAMO;AACLL,QAAAA,OAAO,CAACC,GAAR,CAAYsB,CAAZ;AACAlB,QAAAA,MAAM,CAAC,oDAAD,CAAN;AACD;AACF,KAfH;AAgBD,GAjBD,MAiBO;AACLR,IAAAA,YAAY,CAAC8B,OAAb,CAAqB,MAArB,EAA6BlC,SAA7B;AACAW,IAAAA,OAAO,CAACU,QAAD,CAAP;AACD;AACF,CAzBD","sourcesContent":["import { GET_EVENTS_BEGIN } from '../actions/events';\nimport { duplicateAction } from '../actions/db/events';\nimport { map, mergeMap, catchError } from 'rxjs/operators';\nimport { ofType } from 'redux-observable';\nimport { from } from 'rxjs';\nimport { normalize, schema } from 'normalizr';\n\nasync function loadGoogleClient() {\n  let result = await window.gapi.load('calendar', 'v3');\n  return result;\n}\n\nasync function loadRequest(isSync) {\n  if(isSync) {\n    let result = await window.gapi.client.calendar.events.list({\n      'calendarId' : 'primary',\n      'syncToken'  : syncToken\n    })\n  }\n  else {\n    let result = await window.gapi.client.calendar.events.list({\n      'calendarId' : 'primary'\n    });\n  }\n  return result;\n}\n\nexport const beginGetEventsEpics = action$ => action$.pipe(\n  ofType(GET_EVENTS_BEGIN),\n  mergeMap(() => {\n    const load =  loadGoogleClient();\n    mergeMap(() => {\n      let syncToken = localStorage.getItem('sync');\n      let request;\n      if(syncToken == null) {\n        console.log('performing full sync');\n        request = loadRequst(false);\n      }\n      else {\n        console.log('performing incremental sync');\n        request = new Promise((resolve,reject) => {\n          return resolve()\n        });\n      }\n      debugger\n      from(request).pipe(\n        map(resp => {\n          let result = [];\n          const results = new Promise((resolve, reject) => {\n            fetchEvents(resp, result, resolve, reject);\n          })\n          debugger;\n          return duplicateAction();\n        })\n      )\n    })\n    /*window.gapi.client.load('calendar', 'v3')\n      .then(() => {\n        let syncToken = localStorage.getItem('sync');\n        let request;\n        if(syncToken == null) {\n          console.log('performing full sync');\n          request =  window.gapi.client.calendar.events.list({\n            'calendarId' : 'primary'\n          });\n        }\n        else {\n          console.log('performing incremental sync');\n          request = window.gapi.client.calendar.events.list({\n            'calendarId' : 'primary',\n            'syncToken': syncToken\n          });\n        }\n        return request;\n      })\n      .then(resp => {\n        let result = [];\n        const results = new Promise((resolve, reject) => {\n          fetchEvents(resp, result, resolve, reject);\n        })\n        return results;\n      })\n      .then(response => {\n        debugger;\n      })\n      return duplicateAction();*/\n  })\n)\n\nconst normalizeEvents = (response) => {\n  let singleEvent = new schema.Entity('events');\n  let results = normalize({ events : response}, { events: [ singleEvent ]});\n  return results;\n}\n\nconst fetchEvents = (resp, items, resolve, reject) => {\n  const newItems = items.concat(resp.result.items);\n  let pageToken = resp.nextPageToken;\n  let syncToken = resp.nextSyncToken;\n  if(pageToken !== undefined) {\n    window.gapi.client.calendar.events.list({\n      'calendarId' : 'primary',\n      'pageToken': pageToken\n    }).then(nextResp => fetchEvents(nextResp, newItems, resolve, reject))\n      .catch(e => {\n        if(e.code === 410) {\n          console.log('Invalid sync token, clearing event store and re-syncing.');\n          localStorage.deleteItem('sync');\n          window.gapi.client.calendar.events.list({\n            'calendarId' : 'primary',\n          }).then(newResp => fetchEvents(newResp, items, resolve, reject))\n        } else {\n          console.log(e);\n          reject('Something went wrong, Please refresh and try again');\n        }\n      })\n  } else {\n    localStorage.setItem('sync', syncToken);\n    resolve(newItems);\n  }\n}\n"]},"metadata":{},"sourceType":"module"}
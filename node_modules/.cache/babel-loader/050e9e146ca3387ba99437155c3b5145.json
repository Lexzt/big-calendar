{"ast":null,"code":"/**\n * this is based on\n * @link https://github.com/aheckmann/mquery/blob/master/lib/mquery.js\n */\nimport { isObject, merge as _merge, mergeClone } from './mquery_utils';\nimport RxError from '../rx-error';\nimport { clone as _clone } from '../util';\n\nvar MQuery =\n/*#__PURE__*/\nfunction () {\n  /**\n   * MQuery constructor used for building queries.\n   *\n   * ####Example:\n   *     var query = new MQuery({ name: 'mquery' });\n   *     query.where('age').gte(21).exec(callback);\n   *\n   * @param {Object} [criteria]\n   */\n  function MQuery(criteria) {\n    var proto = this.constructor.prototype;\n    this.options = {};\n    this._conditions = proto._conditions ? _clone(proto._conditions) : {};\n    this._fields = proto._fields ? _clone(proto._fields) : undefined;\n    this._path = proto._path || undefined;\n    if (criteria) this.find(criteria);\n  }\n  /**\n   * returns a cloned version of the query\n   * @return {MQuery}\n   */\n\n\n  var _proto = MQuery.prototype;\n\n  _proto.clone = function clone() {\n    var same = new MQuery();\n    Object.entries(this).forEach(function (_ref) {\n      var k = _ref[0],\n          v = _ref[1];\n      return same[k] = _clone(v);\n    });\n    return same;\n  };\n  /**\n   * Specifies a `path` for use with chaining.\n   * @param {String} [path]\n   * @param {Object} [val]\n   * @return {MQuery} this\n   */\n\n\n  _proto.where = function where() {\n    if (!arguments.length) return this;\n    var type = typeof arguments[0];\n\n    if ('string' === type) {\n      this._path = arguments[0];\n      if (2 === arguments.length) this._conditions[this._path] = arguments[1];\n      return this;\n    }\n\n    if ('object' === type && !Array.isArray(arguments[0])) return this.merge(arguments[0]);\n    throw RxError.newRxTypeError('MQ1', {\n      path: arguments[0]\n    });\n  };\n  /**\n   * Specifies the complementary comparison value for paths specified with `where()`\n   * ####Example\n   *     User.where('age').equals(49);\n   * @param {Object} val\n   * @return {MQuery} this\n   */\n\n\n  _proto.equals = function equals(val) {\n    this._ensurePath('equals');\n\n    var path = this._path;\n    this._conditions[path] = val;\n    return this;\n  };\n  /**\n   * Specifies the complementary comparison value for paths specified with `where()`\n   * This is alias of `equals`\n   * @param {Object} val\n   * @return {MQuery} this\n   */\n\n\n  _proto.eq = function eq(val) {\n    this._ensurePath('eq');\n\n    var path = this._path;\n    this._conditions[path] = val;\n    return this;\n  };\n  /**\n   * Specifies arguments for an `$or` condition.\n   * ####Example\n   *     query.or([{ color: 'red' }, { status: 'emergency' }])\n   * @param {Array} array array of conditions\n   * @return {MQuery} this\n   */\n\n\n  _proto.or = function or(array) {\n    var or = this._conditions.$or || (this._conditions.$or = []);\n    if (!Array.isArray(array)) array = [array];\n    or.push.apply(or, array);\n    return this;\n  };\n  /**\n   * Specifies arguments for a `$nor` condition.\n   * ####Example\n   *     query.nor([{ color: 'green' }, { status: 'ok' }])\n   * @param {Array} array array of conditions\n   * @return {MQuery} this\n   */\n\n\n  _proto.nor = function nor(array) {\n    var nor = this._conditions.$nor || (this._conditions.$nor = []);\n    if (!Array.isArray(array)) array = [array];\n    nor.push.apply(nor, array);\n    return this;\n  };\n  /**\n   * Specifies arguments for a `$and` condition.\n   * ####Example\n   *     query.and([{ color: 'green' }, { status: 'ok' }])\n   * @see $and http://docs.mongodb.org/manual/reference/operator/and/\n   * @param {Array} array array of conditions\n   * @return {MQuery} this\n   */\n\n\n  _proto.and = function and(array) {\n    var and = this._conditions.$and || (this._conditions.$and = []);\n    if (!Array.isArray(array)) array = [array];\n    and.push.apply(and, array);\n    return this;\n  };\n  /**\n   * Specifies a `$mod` condition\n   *\n   * @param {String} [path]\n   * @param {Number} val\n   * @return {MQuery} this\n   * @api public\n   */\n\n\n  _proto.mod = function mod() {\n    var val;\n    var path;\n\n    if (1 === arguments.length) {\n      this._ensurePath('mod');\n\n      val = arguments[0];\n      path = this._path;\n    } else if (2 === arguments.length && !Array.isArray(arguments[1])) {\n      this._ensurePath('mod');\n\n      val = arguments.slice();\n      path = this._path;\n    } else if (3 === arguments.length) {\n      val = arguments.slice(1);\n      path = arguments[0];\n    } else {\n      val = arguments[1];\n      path = arguments[0];\n    }\n\n    var conds = this._conditions[path] || (this._conditions[path] = {});\n    conds.$mod = val;\n    return this;\n  };\n  /**\n   * Specifies an `$exists` condition\n   * ####Example\n   *     // { name: { $exists: true }}\n   *     Thing.where('name').exists()\n   *     Thing.where('name').exists(true)\n   *     Thing.find().exists('name')\n   * @param {String} [path]\n   * @param {Number} val\n   * @return {MQuery} this\n   * @api public\n   */\n\n\n  _proto.exists = function exists() {\n    var path;\n    var val;\n\n    if (0 === arguments.length) {\n      this._ensurePath('exists');\n\n      path = this._path;\n      val = true;\n    } else if (1 === arguments.length) {\n      if ('boolean' === typeof arguments[0]) {\n        this._ensurePath('exists');\n\n        path = this._path;\n        val = arguments[0];\n      } else {\n        path = arguments[0];\n        val = true;\n      }\n    } else if (2 === arguments.length) {\n      path = arguments[0];\n      val = arguments[1];\n    }\n\n    var conds = this._conditions[path] || (this._conditions[path] = {});\n    conds.$exists = val;\n    return this;\n  };\n  /**\n   * Specifies an `$elemMatch` condition\n   * ####Example\n   *     query.elemMatch('comment', { author: 'autobot', votes: {$gte: 5}})\n   *     query.where('comment').elemMatch({ author: 'autobot', votes: {$gte: 5}})\n   *     query.elemMatch('comment', function (elem) {\n   *       elem.where('author').equals('autobot');\n   *       elem.where('votes').gte(5);\n   *     })\n   *     query.where('comment').elemMatch(function (elem) {\n   *       elem.where({ author: 'autobot' });\n   *       elem.where('votes').gte(5);\n   *     })\n   * @param {String|Object|Function} path\n   * @param {Object|Function} criteria\n   * @return {MQuery} this\n   */\n\n\n  _proto.elemMatch = function elemMatch() {\n    if (null === arguments[0]) throw RxError.newRxTypeError('MQ2');\n    var fn;\n    var path;\n    var criteria;\n\n    if ('function' === typeof arguments[0]) {\n      this._ensurePath('elemMatch');\n\n      path = this._path;\n      fn = arguments[0];\n    } else if (isObject(arguments[0])) {\n      this._ensurePath('elemMatch');\n\n      path = this._path;\n      criteria = arguments[0];\n    } else if ('function' === typeof arguments[1]) {\n      path = arguments[0];\n      fn = arguments[1];\n    } else if (arguments[1] && isObject(arguments[1])) {\n      path = arguments[0];\n      criteria = arguments[1];\n    } else throw RxError.newRxTypeError('MQ2');\n\n    if (fn) {\n      criteria = new MQuery();\n      fn(criteria);\n      criteria = criteria._conditions;\n    }\n\n    var conds = this._conditions[path] || (this._conditions[path] = {});\n    conds.$elemMatch = criteria;\n    return this;\n  };\n  /**\n   * Sets the sort order\n   * If an object is passed, values allowed are 'asc', 'desc', 'ascending', 'descending', 1, and -1.\n   * If a string is passed, it must be a space delimited list of path names. The sort order of each path is ascending unless the path name is prefixed with `-` which will be treated as descending.\n   * ####Example\n   *     query.sort({ field: 'asc', test: -1 });\n   *     query.sort('field -test');\n   *     query.sort([['field', 1], ['test', -1]]);\n   * @param {Object|String|Array} arg\n   * @return {MQuery} this\n   */\n\n\n  _proto.sort = function sort(arg) {\n    var _this = this;\n\n    if (!arg) return this;\n    var len;\n    var type = typeof arg; // .sort([['field', 1], ['test', -1]])\n\n    if (Array.isArray(arg)) {\n      len = arg.length;\n\n      for (var i = 0; i < arg.length; ++i) {\n        _pushArr(this.options, arg[i][0], arg[i][1]);\n      }\n\n      return this;\n    } // .sort('field -test')\n\n\n    if (1 === arguments.length && 'string' === type) {\n      arg = arg.split(/\\s+/);\n      len = arg.length;\n\n      for (var _i = 0; _i < len; ++_i) {\n        var field = arg[_i];\n        if (!field) continue;\n        var ascend = '-' === field[0] ? -1 : 1;\n        if (ascend === -1) field = field.substring(1);\n        push(this.options, field, ascend);\n      }\n\n      return this;\n    } // .sort({ field: 1, test: -1 })\n\n\n    if (isObject(arg)) {\n      var keys = Object.keys(arg);\n      keys.forEach(function (field) {\n        return push(_this.options, field, arg[field]);\n      });\n      return this;\n    }\n\n    throw RxError.newRxTypeError('MQ3', {\n      args: arguments\n    });\n  };\n  /**\n   * Merges another MQuery or conditions object into this one.\n   *\n   * When a MQuery is passed, conditions, field selection and options are merged.\n   *\n   * @param {MQuery|Object} source\n   * @return {MQuery} this\n   */\n\n\n  _proto.merge = function merge(source) {\n    if (!source) return this;\n\n    if (!MQuery.canMerge(source)) {\n      throw RxError.newRxTypeError('MQ4', {\n        source: source\n      });\n    }\n\n    if (source instanceof MQuery) {\n      // if source has a feature, apply it to ourselves\n      if (source._conditions) _merge(this._conditions, source._conditions);\n\n      if (source._fields) {\n        this._fields || (this._fields = {});\n\n        _merge(this._fields, source._fields);\n      }\n\n      if (source.options) {\n        this.options || (this.options = {});\n\n        _merge(this.options, source.options);\n      }\n\n      if (source._update) {\n        this._update || (this._update = {});\n        mergeClone(this._update, source._update);\n      }\n\n      if (source._distinct) this._distinct = source._distinct;\n      return this;\n    } // plain object\n\n\n    _merge(this._conditions, source);\n\n    return this;\n  };\n  /**\n   * Finds documents.\n   * ####Example\n   *     query.find()\n   *     query.find({ name: 'Burning Lights' })\n   * @param {Object} [criteria] mongodb selector\n   * @return {MQuery} this\n   */\n\n\n  _proto.find = function find(criteria) {\n    if (MQuery.canMerge(criteria)) this.merge(criteria);\n    return this;\n  };\n  /**\n   * Make sure _path is set.\n   *\n   * @parmam {String} method\n   */\n\n\n  _proto._ensurePath = function _ensurePath(method) {\n    if (!this._path) {\n      throw RxError.newRxError('MQ5', {\n        method: method\n      });\n    }\n  };\n\n  return MQuery;\n}();\n/**\n * gt, gte, lt, lte, ne, in, nin, all, regex, size, maxDistance\n *\n *     Thing.where('type').nin(array)\n */\n\n\n['gt', 'gte', 'lt', 'lte', 'ne', 'in', 'nin', 'all', 'regex', 'size'].forEach(function ($conditional) {\n  MQuery.prototype[$conditional] = function () {\n    var path;\n    var val;\n\n    if (1 === arguments.length) {\n      this._ensurePath($conditional);\n\n      val = arguments[0];\n      path = this._path;\n    } else {\n      val = arguments[1];\n      path = arguments[0];\n    }\n\n    var conds = this._conditions[path] === null || typeof this._conditions[path] === 'object' ? this._conditions[path] : this._conditions[path] = {};\n    conds['$' + $conditional] = val;\n    return this;\n  };\n});\n/*!\n * @ignore\n */\n\nfunction push(opts, field, value) {\n  if (Array.isArray(opts.sort)) {\n    throw RxError.newRxTypeError('MQ6', {\n      opts: opts,\n      field: field,\n      value: value\n    });\n  }\n\n  if (value && value.$meta) {\n    var _s = opts.sort || (opts.sort = {});\n\n    _s[field] = {\n      $meta: value.$meta\n    };\n    return;\n  }\n\n  var val = String(value || 1).toLowerCase();\n\n  if (!/^(?:ascending|asc|descending|desc|1|-1)$/.test(val)) {\n    if (Array.isArray(value)) value = '[' + value + ']';\n    throw RxError.newRxTypeError('MQ7', {\n      field: field,\n      value: value\n    });\n  } // store `sort` in a sane format\n\n\n  var s = opts.sort || (opts.sort = {});\n  var valueStr = value.toString().replace('asc', '1').replace('ascending', '1').replace('desc', '-1').replace('descending', '-1');\n  s[field] = parseInt(valueStr, 10);\n}\n\nfunction _pushArr(opts, field, value) {\n  opts.sort = opts.sort || [];\n\n  if (!Array.isArray(opts.sort)) {\n    throw RxError.newRxTypeError('MQ8', {\n      opts: opts,\n      field: field,\n      value: value\n    });\n  }\n  /*    const valueStr = value.toString()\n          .replace('asc', '1')\n          .replace('ascending', '1')\n          .replace('desc', '-1')\n          .replace('descending', '-1');*/\n\n\n  opts.sort.push([field, value]);\n}\n/**\n * Determines if `conds` can be merged using `mquery().merge()`\n *\n * @param {Object} conds\n * @return {Boolean}\n */\n\n\nMQuery.canMerge = function (conds) {\n  return conds instanceof MQuery || isObject(conds);\n};\n/**\n * limit, skip, maxScan, batchSize, comment\n *\n * Sets these associated options.\n *\n *     query.comment('feed query');\n */\n\n\n['limit', 'skip', 'maxScan', 'batchSize', 'comment'].forEach(function (method) {\n  MQuery.prototype[method] = function (v) {\n    this.options[method] = v;\n    return this;\n  };\n});\nexport default MQuery;","map":null,"metadata":{},"sourceType":"module"}
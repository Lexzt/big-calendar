{"ast":null,"code":"import { GET_EVENTS_BEGIN } from '../actions/events';\nimport { duplicateAction } from '../actions/db/events';\nimport { map, mergeMap, catchError } from 'rxjs/operators';\nimport { ofType } from 'redux-observable';\nimport { from } from 'rxjs';\nimport { normalize, schema } from 'normalizr';\nexport var beginGetEventsEpics = function beginGetEventsEpics(action$) {\n  return action$.pipe(ofType(GET_EVENTS_BEGIN), mergeMap(function () {\n    var load = new Promise(window.gapi.client.load('calendar', 'v3'));\n    from(load).pipe(mergeMap(function () {\n      var syncToken = localStorage.getItem('sync');\n      var request;\n\n      if (syncToken == null) {\n        console.log('performing full sync');\n        request = new Promise(window.gapi.client.calendar.events.list({\n          'calendarId': 'primary'\n        }));\n      } else {\n        console.log('performing incremental sync');\n        request = new Promise(window.gapi.client.calendar.events.list({\n          'calendarId': 'primary',\n          'syncToken': syncToken\n        }));\n      }\n\n      from(request).pipe(map(function (resp) {\n        var result = [];\n        var results = new Promise(function (resolve, reject) {\n          fetchEvents(resp, result, resolve, reject);\n        });\n        debugger;\n        return duplicateAction();\n      }));\n    }));\n    window.gapi.client.load('calendar', 'v3').then(function () {\n      var syncToken = localStorage.getItem('sync');\n      var request;\n\n      if (syncToken == null) {\n        console.log('performing full sync');\n        request = window.gapi.client.calendar.events.list({\n          'calendarId': 'primary'\n        });\n      } else {\n        console.log('performing incremental sync');\n        request = window.gapi.client.calendar.events.list({\n          'calendarId': 'primary',\n          'syncToken': syncToken\n        });\n      }\n\n      return request;\n    }).then(function (resp) {\n      var result = [];\n      var results = new Promise(function (resolve, reject) {\n        fetchEvents(resp, result, resolve, reject);\n      });\n      return results;\n    }).then(function (response) {\n      debugger;\n    });\n    return duplicateAction();\n  }));\n};\n\nvar normalizeEvents = function normalizeEvents(response) {\n  var singleEvent = new schema.Entity('events');\n  var results = normalize({\n    events: response\n  }, {\n    events: [singleEvent]\n  });\n  return results;\n};\n\nvar fetchEvents = function fetchEvents(resp, items, resolve, reject) {\n  var newItems = items.concat(resp.result.items);\n  var pageToken = resp.nextPageToken;\n  var syncToken = resp.nextSyncToken;\n\n  if (pageToken !== undefined) {\n    window.gapi.client.calendar.events.list({\n      'calendarId': 'primary',\n      'pageToken': pageToken\n    }).then(function (nextResp) {\n      return fetchEvents(nextResp, newItems, resolve, reject);\n    }).catch(function (e) {\n      if (e.code === 410) {\n        console.log('Invalid sync token, clearing event store and re-syncing.');\n        localStorage.deleteItem('sync');\n        window.gapi.client.calendar.events.list({\n          'calendarId': 'primary'\n        }).then(function (newResp) {\n          return fetchEvents(newResp, items, resolve, reject);\n        });\n      } else {\n        console.log(e);\n        reject('Something went wrong, Please refresh and try again');\n      }\n    });\n  } else {\n    localStorage.setItem('sync', syncToken);\n    resolve(newItems);\n  }\n};","map":{"version":3,"sources":["/Users/sham/big-calendar/src/epics/events.js"],"names":["GET_EVENTS_BEGIN","duplicateAction","map","mergeMap","catchError","ofType","from","normalize","schema","beginGetEventsEpics","action$","pipe","load","Promise","window","gapi","client","syncToken","localStorage","getItem","request","console","log","calendar","events","list","resp","result","results","resolve","reject","fetchEvents","then","response","normalizeEvents","singleEvent","Entity","items","newItems","concat","pageToken","nextPageToken","nextSyncToken","undefined","nextResp","catch","e","code","deleteItem","newResp","setItem"],"mappings":"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","sourcesContent":["import { GET_EVENTS_BEGIN } from '../actions/events';\nimport { duplicateAction } from '../actions/db/events';\nimport { map, mergeMap, catchError } from 'rxjs/operators';\nimport { ofType } from 'redux-observable';\nimport { from } from 'rxjs';\nimport { normalize, schema } from 'normalizr';\n\n\nexport const beginGetEventsEpics = action$ => action$.pipe(\n  ofType(GET_EVENTS_BEGIN),\n  mergeMap(() => {\n    let load = new Promise(window.gapi.client.load('calendar', 'v3'));\n    from(load).pipe(\n      mergeMap(() => {\n        let syncToken = localStorage.getItem('sync');\n        let request;\n        if(syncToken == null) {\n          console.log('performing full sync');\n          request =  new Promise(window.gapi.client.calendar.events.list({\n            'calendarId' : 'primary'\n          }));\n        }\n        else {\n          console.log('performing incremental sync');\n          request = new Promise(window.gapi.client.calendar.events.list({\n            'calendarId' : 'primary',\n            'syncToken': syncToken\n          }));\n        }\n        from(request).pipe(\n          map(resp => {\n            let result = [];\n            const results = new Promise((resolve, reject) => {\n              fetchEvents(resp, result, resolve, reject);\n            })\n            debugger;\n            return duplicateAction();\n          })\n        )\n      })\n    )\n    window.gapi.client.load('calendar', 'v3')\n      .then(() => {\n        let syncToken = localStorage.getItem('sync');\n        let request;\n        if(syncToken == null) {\n          console.log('performing full sync');\n          request =  window.gapi.client.calendar.events.list({\n            'calendarId' : 'primary'\n          });\n        }\n        else {\n          console.log('performing incremental sync');\n          request = window.gapi.client.calendar.events.list({\n            'calendarId' : 'primary',\n            'syncToken': syncToken\n          });\n        }\n        return request;\n      })\n      .then(resp => {\n        let result = [];\n        const results = new Promise((resolve, reject) => {\n          fetchEvents(resp, result, resolve, reject);\n        })\n        return results;\n      })\n      .then(response => {\n        debugger;\n      })\n      return duplicateAction();\n  })\n)\n\nconst normalizeEvents = (response) => {\n  let singleEvent = new schema.Entity('events');\n  let results = normalize({ events : response}, { events: [ singleEvent ]});\n  return results;\n}\n\nconst fetchEvents = (resp, items, resolve, reject) => {\n  const newItems = items.concat(resp.result.items);\n  let pageToken = resp.nextPageToken;\n  let syncToken = resp.nextSyncToken;\n  if(pageToken !== undefined) {\n    window.gapi.client.calendar.events.list({\n      'calendarId' : 'primary',\n      'pageToken': pageToken\n    }).then(nextResp => fetchEvents(nextResp, newItems, resolve, reject))\n      .catch(e => {\n        if(e.code === 410) {\n          console.log('Invalid sync token, clearing event store and re-syncing.');\n          localStorage.deleteItem('sync');\n          window.gapi.client.calendar.events.list({\n            'calendarId' : 'primary',\n          }).then(newResp => fetchEvents(newResp, items, resolve, reject))\n        } else {\n          console.log(e);\n          reject('Something went wrong, Please refresh and try again');\n        }\n      })\n  } else {\n    localStorage.setItem('sync', syncToken);\n    resolve(newItems);\n  }\n}\n"]},"metadata":{},"sourceType":"module"}